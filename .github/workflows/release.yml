name: Auto Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.detect.outputs.modules }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git diff

      - name: Detect changed modules
        id: detect
        run: |
          # Make script executable
          chmod +x .github/scripts/detect-changed-modules.sh

          # Run detection script
          MODULES=$(.github/scripts/detect-changed-modules.sh)

          # Check if array is empty
          if [ "$MODULES" = "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "modules=[]" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "modules=$MODULES" >> $GITHUB_OUTPUT
          fi

          echo "Changed modules: $MODULES"

  release:
    name: Release ${{ matrix.module }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}
      fail-fast: false  # Continue releasing other modules if one fails
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ matrix.module }}/go.mod

      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/*.sh

      - name: Get module version
        id: version
        run: |
          VERSION=$(.github/scripts/get-module-version.sh ${{ matrix.module }})
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

          # Extract just the version number (without module prefix)
          VERSION_NUMBER=${VERSION#${{ matrix.module }}/}
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Run tests
        run: |
          .github/scripts/run-module-tests.sh ${{ matrix.module }}

      - name: Generate changelog
        id: changelog
        run: |
          # Get last tag for this module (if exists)
          LAST_TAG=$(git tag --list "${{ matrix.module }}/v*.*.*" --sort=-v:refname | head -n 1)

          # Generate changelog
          CHANGELOG=$(.github/scripts/generate-changelog.sh ${{ matrix.module }} "$LAST_TAG")

          # Save changelog to file for GitHub release
          echo "$CHANGELOG" > changelog.md

          # Also output for debugging
          echo "Changelog:"
          cat changelog.md

      - name: Create Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.version.outputs.version }}" \
            --title "${{ matrix.module }} ${{ steps.version.outputs.version_number }}" \
            --notes-file changelog.md \
            --latest=false

      - name: Release Summary
        run: |
          echo "âœ… Successfully released ${{ matrix.module }} ${{ steps.version.outputs.version_number }}"
          echo ""
          echo "Install with:"
          echo "  go get github.com/seb7887/gofw/${{ matrix.module }}@${{ steps.version.outputs.version_number }}"
